<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>NodeJS 学习笔记 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="初识 Node.js简介Node.js 是什么node.js 是一个基于 Chorme V8 引擎的 JavaScript 开发环境。 浏览器是 JavaSript 的前端运行环境，node.js 是 JavaScript 的后端运行环境。 node.js 中无法调用 DOM 和 BOM 等浏览器内置 API。 Node.js 可以做什么 基于 Express 框架（Express），可以快速构建">
<meta property="og:type" content="article">
<meta property="og:title" content="NodeJS 学习笔记">
<meta property="og:url" content="http://example.com/2023/04/27/NodeJS-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="初识 Node.js简介Node.js 是什么node.js 是一个基于 Chorme V8 引擎的 JavaScript 开发环境。 浏览器是 JavaSript 的前端运行环境，node.js 是 JavaScript 的后端运行环境。 node.js 中无法调用 DOM 和 BOM 等浏览器内置 API。 Node.js 可以做什么 基于 Express 框架（Express），可以快速构建">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-04-27T12:31:08.000Z">
<meta property="article:modified_time" content="2023-04-27T12:31:58.041Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-NodeJS-学习笔记" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/04/27/NodeJS-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="article-date">
  <time class="dt-published" datetime="2023-04-27T12:31:08.000Z" itemprop="datePublished">2023-04-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      NodeJS 学习笔记
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="初识-Node-js"><a href="#初识-Node-js" class="headerlink" title="初识 Node.js"></a>初识 Node.js</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><h3 id="Node-js-是什么"><a href="#Node-js-是什么" class="headerlink" title="Node.js 是什么"></a>Node.js 是什么</h3><p>node.js 是一个基于 Chorme V8 引擎的 JavaScript 开发环境。</p>
<p>浏览器是 JavaSript 的前端运行环境，node.js 是 JavaScript 的后端运行环境。</p>
<p>node.js 中无法调用 DOM 和 BOM 等浏览器内置 API。</p>
<h3 id="Node-js-可以做什么"><a href="#Node-js-可以做什么" class="headerlink" title="Node.js 可以做什么"></a>Node.js 可以做什么</h3><ul>
<li><p>基于 Express 框架（<a target="_blank" rel="noopener" href="https://www.expressjs.com.cn/">Express</a>），可以快速构建Web应用。</p>
</li>
<li><p>基于 Electron 框架（<a target="_blank" rel="noopener" href="https://www.electronjs.org/">Electron</a>），可以构建跨平台的桌面应用。</p>
</li>
<li><p>基于 restify 框架（<a target="_blank" rel="noopener" href="http://restify.com/">Restify</a>），可以快速构建API接口项目。</p>
</li>
<li><p>读写和操作数据库、创建实用的命令行工具辅助前端开发、etc······。</p>
</li>
</ul>
<h2 id="学习路径"><a href="#学习路径" class="headerlink" title="学习路径"></a>学习路径</h2><p>JavaScript基础语法 + Node.js 内置 API 模块（fs、path、http 等）+ 第三方 API 模块（express、mysql 等）。</p>
<h2 id="环境安装"><a href="#环境安装" class="headerlink" title="环境安装"></a>环境安装</h2><p>LTS 为长期稳定版，Current 为新特性尝鲜版。</p>
<p>查看已安装 Node.js 版本号：终端命令 <code>node -v</code>。</p>
<h2 id="在-Node-js-环境中执行-JavaScript-代码"><a href="#在-Node-js-环境中执行-JavaScript-代码" class="headerlink" title="在 Node.js 环境中执行 JavaScript 代码"></a>在 Node.js 环境中执行 JavaScript 代码</h2><p>终端命令：<code>node &quot;js文件路径&quot;</code>。</p>
<h1 id="fs-文件系统模块"><a href="#fs-文件系统模块" class="headerlink" title="fs 文件系统模块"></a>fs 文件系统模块</h1><h2 id="什么是-fs-文件系统模块"><a href="#什么是-fs-文件系统模块" class="headerlink" title="什么是 fs 文件系统模块"></a>什么是 fs 文件系统模块</h2><p>Node.js 官方提供的、用来操作文件的模块。</p>
<p>它提供了操作文件的方法和属性，例如：</p>
<ul>
<li><code>fs.readFile()</code>：读取指定文件内容。</li>
<li><code>fs.writeFile()</code>：向指定文件写入内容。</li>
</ul>
<p>导入方式：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="读取指定文件中的内容"><a href="#读取指定文件中的内容" class="headerlink" title="读取指定文件中的内容"></a>读取指定文件中的内容</h2><h3 id="fs-readFile-语法格式"><a href="#fs-readFile-语法格式" class="headerlink" title="fs.readFile() 语法格式"></a>fs.readFile() 语法格式</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fs.<span class="title function_">readFile</span>(path[, options], callback)</span><br></pre></td></tr></table></figure>

<p>中括号内代表可选参数。</p>
<p>参数解读：</p>
<ul>
<li><code>path</code>：必选参数，字符串，表示文件的路径。</li>
<li><code>options</code>：可选参数，编码格式。</li>
<li><code>callback</code>：必选参数，读取完成后，拿到读取结果的回调函数。</li>
</ul>
<h3 id="fs-readFile-示例代码"><a href="#fs-readFile-示例代码" class="headerlink" title="fs.readFile() 示例代码"></a>fs.readFile() 示例代码</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"></span><br><span class="line">fs.<span class="title function_">readFile</span>(<span class="string">&#x27;1.json&#x27;</span>, <span class="string">&#x27;utf8&#x27;</span>, <span class="keyword">function</span>(<span class="params">err,dataStr</span>)&#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(err)</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;------&#x27;</span>)</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(dataStr)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>读取成功时，err 的值为 null。</li>
<li>读取失败时，dataStr 的值为 undefined。</li>
</ul>
<h3 id="判断文件是否读取成功"><a href="#判断文件是否读取成功" class="headerlink" title="判断文件是否读取成功"></a>判断文件是否读取成功</h3><p>通过判断 err 是否为 null 来实现。</p>
<h2 id="向指定文件中写入内容"><a href="#向指定文件中写入内容" class="headerlink" title="向指定文件中写入内容"></a>向指定文件中写入内容</h2><h3 id="fs-writeFile-语法格式"><a href="#fs-writeFile-语法格式" class="headerlink" title="fs.writeFile() 语法格式"></a>fs.writeFile() 语法格式</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fs.<span class="title function_">writeFile</span>(file, data[, options], callback)</span><br></pre></td></tr></table></figure>

<p>参数解读：</p>
<ul>
<li><code>file</code>：必选参数，文件路径。</li>
<li><code>data</code>：必选参数，写入的内容。</li>
<li><code>options</code>：可选参数，写入格式，默认utf8。</li>
<li><code>callback</code>：回调函数。</li>
</ul>
<h3 id="fs-writeFile-示例代码"><a href="#fs-writeFile-示例代码" class="headerlink" title="fs.writeFile() 示例代码"></a>fs.writeFile() 示例代码</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"></span><br><span class="line">fs.<span class="title function_">writeFile</span>(<span class="string">&#x27;test.json&#x27;</span>, <span class="string">&#x27;1234&#x27;</span>, <span class="string">&#x27;utf8&#x27;</span>, <span class="keyword">function</span>(<span class="params">err</span>)&#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(err)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>写入成功时，err 为 null。</p>
<h3 id="判断文件是否写入成功"><a href="#判断文件是否写入成功" class="headerlink" title="判断文件是否写入成功"></a>判断文件是否写入成功</h3><p>通过判断 err 是否为 null 来实现。</p>
<h3 id="fs-writeFile-的注意点"><a href="#fs-writeFile-的注意点" class="headerlink" title="fs.writeFile() 的注意点"></a>fs.writeFile() 的注意点</h3><ol>
<li>fs.writeFile() 方法只能用来创建文件，不能用来创建路径。</li>
<li>重复调用 fs.writeFile() 写入同一文件，新内容会覆盖旧内容。</li>
</ol>
<h2 id="fs-模块路径动态拼接问题"><a href="#fs-模块路径动态拼接问题" class="headerlink" title="fs 模块路径动态拼接问题"></a>fs 模块路径动态拼接问题</h2><p>不同的控制台目录运行同一个 js 文件时，js 中的相对路径是相对于控制台目录的。容易引起找不到文件的问题。</p>
<p>绝对路径不宜与维护。</p>
<p>解决方案：使用 <code>__dirname</code> 表示当前文件所处的目录。即被运行的文件所处的目录。</p>
<p>使用示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"></span><br><span class="line">fs.<span class="title function_">readFile</span>(__dirname+<span class="string">&#x27;/1.json&#x27;</span>, <span class="string">&#x27;utf8&#x27;</span>, <span class="keyword">function</span>(<span class="params">err,dataStr</span>)&#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(err)</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;------&#x27;</span>)</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(dataStr)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>







<h1 id="path-路径模块"><a href="#path-路径模块" class="headerlink" title="path 路径模块"></a>path 路径模块</h1><p>Node.js 官方提供的、用来处理路径的模块。</p>
<p>提供了一些 方法和属性。例如：</p>
<ul>
<li><code>path.join()</code>: 把多个路径片段拼接成一个路径字符串。</li>
<li><code>path.basename()</code>: 从路径字符串中解析文件名。</li>
</ul>
<p>导入方式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="path-join-路径拼接"><a href="#path-join-路径拼接" class="headerlink" title="path.join() 路径拼接"></a>path.join() 路径拼接</h2><h3 id="语法格式"><a href="#语法格式" class="headerlink" title="语法格式"></a>语法格式</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path.<span class="title function_">join</span>([...paths])</span><br></pre></td></tr></table></figure>

<p>参数解读</p>
<ul>
<li><code>...paths</code>: 字符串路径片段的序列。</li>
<li>返回值: 字符串类型</li>
</ul>
<h3 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line">pathStr = path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;../&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(pathStr)</span><br></pre></td></tr></table></figure>

<p>和 <code>+</code> 的区别为：加号不能拼接 <code>../</code>。</p>
<h2 id="获取路径中的文件名"><a href="#获取路径中的文件名" class="headerlink" title="获取路径中的文件名"></a>获取路径中的文件名</h2><blockquote>
<p>path.basename()</p>
</blockquote>
<h3 id="语法格式-1"><a href="#语法格式-1" class="headerlink" title="语法格式"></a>语法格式</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path.<span class="title function_">basename</span>(path[, ext])</span><br></pre></td></tr></table></figure>

<p>参数解读：</p>
<ul>
<li><code>path</code>: 字符串，必选参数，路径的字符串。</li>
<li><code>ext</code>: 字符串，可选参数，表示文件拓展名。</li>
<li>返回值: 字符串，表示路径中的最后一部分。</li>
</ul>
<h3 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pathStr = path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;../assets/html/index.html&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(pathStr);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fullName = path.<span class="title function_">basename</span>(pathStr)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(fullName) <span class="comment">//输出 index.html</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> nameWithoutExt = path.<span class="title function_">basename</span>(pathStr, <span class="string">&#x27;.html&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(nameWithoutExt); <span class="comment">//输出 index</span></span><br></pre></td></tr></table></figure>



<h2 id="获取路径中的文件拓展名"><a href="#获取路径中的文件拓展名" class="headerlink" title="获取路径中的文件拓展名"></a>获取路径中的文件拓展名</h2><blockquote>
<p>path.extname()</p>
</blockquote>
<h3 id="语法格式-2"><a href="#语法格式-2" class="headerlink" title="语法格式"></a>语法格式</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path.<span class="title function_">extname</span>(path)</span><br></pre></td></tr></table></figure>

<p>参数解读：</p>
<ul>
<li><code>path</code>: 字符串，必选参数，路径字符串。</li>
<li>返回值: 字符串，拓展名字符串。</li>
</ul>
<h3 id="代码示例-1"><a href="#代码示例-1" class="headerlink" title="代码示例"></a>代码示例</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pathStr = path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;../assets/html/index.html&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(pathStr);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> extname = path.<span class="title function_">extname</span>(pathStr)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(extname); <span class="comment">//输出 .html</span></span><br></pre></td></tr></table></figure>







<h1 id="http-模块"><a href="#http-模块" class="headerlink" title="http 模块"></a>http 模块</h1><h2 id="什么是-http-模块"><a href="#什么是-http-模块" class="headerlink" title="什么是 http 模块"></a>什么是 http 模块</h2><p>Node.js 官方提供的、用来创建 web 服务器的模块。</p>
<p>通过  <code>http.createServer()</code> 方法创建服务器。</p>
<p>导入方式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="进一步理解-http-模块的作用"><a href="#进一步理解-http-模块的作用" class="headerlink" title="进一步理解 http 模块的作用"></a>进一步理解 http 模块的作用</h2><p>在 Node.js 中，我们不需要使用第三方 web 服务器软件。</p>
<p>使用 http 模块，通过几行简单的代码，就能手写出一个服务器软件。</p>
<h2 id="创建最基本的-web-服务器"><a href="#创建最基本的-web-服务器" class="headerlink" title="创建最基本的 web 服务器"></a>创建最基本的 web 服务器</h2><h3 id="基本步骤"><a href="#基本步骤" class="headerlink" title="基本步骤"></a>基本步骤</h3><ol>
<li>导入 http 模块。</li>
<li>创建 web 服务器实例。</li>
<li>为服务器实例绑定 request 事件，监听客户端请求。</li>
<li>启动服务器。</li>
</ol>
<h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><p><strong>导入 http 模块</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>)</span><br></pre></td></tr></table></figure>



<p><strong>创建 web 服务器实例</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> server = http.<span class="title function_">createServer</span>()</span><br></pre></td></tr></table></figure>



<p><strong>为服务器绑定 request 事件</strong></p>
<p><code>.on()</code> 方法，为服务器绑定 request 事件。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server.<span class="title function_">on</span>(<span class="string">&#x27;request&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;someOne visit our web server.&#x27;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<p><strong>启动服务器</strong></p>
<p><code>.listen()</code> 方法，启动当前 web 实例。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server.<span class="title function_">listen</span>(<span class="number">80</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;http server running at http://127.0.0.1&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<h3 id="回调函数"><a href="#回调函数" class="headerlink" title="回调函数"></a>回调函数</h3><p>req：提供了请求的详细信息。 通过它可以访问请求头和请求的数据。</p>
<p>res：用于构造要返回给客户端的数据。</p>
<p>例如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port = <span class="number">3000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = http.<span class="title function_">createServer</span>(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="property">statusCode</span> = <span class="number">200</span></span><br><span class="line">  res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/plain&#x27;</span>)</span><br><span class="line">  res.<span class="title function_">end</span>(<span class="string">&#x27;你好世界\n&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">listen</span>(port, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`服务器运行在 http://<span class="subst">$&#123;hostname&#125;</span>:<span class="subst">$&#123;port&#125;</span>/`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<h3 id="解决中文乱码问题"><a href="#解决中文乱码问题" class="headerlink" title="解决中文乱码问题"></a>解决中文乱码问题</h3><p>调用 <code>res.end()</code> 传入回写数据时可能会中文乱码。</p>
<p>解决方案：在请求头中设置 <code>utf-8</code> 编码方式。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/html; charset=utf-8&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="根据不同的-url-返回不同的-html-内容"><a href="#根据不同的-url-返回不同的-html-内容" class="headerlink" title="根据不同的 url 返回不同的 html 内容"></a>根据不同的 url 返回不同的 html 内容</h2><h3 id="核心实现步骤"><a href="#核心实现步骤" class="headerlink" title="核心实现步骤"></a>核心实现步骤</h3><ol>
<li>获取请求的 url 地址。</li>
<li>设置默认的相应内容为 404 Not found。</li>
<li>判断用户请求的是否为 <code>/</code> 或 <code>/index.html</code> 首页。</li>
<li>判断用户请求是否为 <code>/about.html</code> 关于页面。</li>
<li>设置响应头防止乱码。</li>
<li>使用 <code>res.end()</code> 把内容相应给客户端。</li>
</ol>
<h3 id="动态响应内容"><a href="#动态响应内容" class="headerlink" title="动态响应内容"></a>动态响应内容</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = http.<span class="title function_">createServer</span>()</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&#x27;request&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> url = req.<span class="property">url</span></span><br><span class="line">    <span class="keyword">let</span> content = <span class="string">&#x27;&lt;h1&gt;Not Found!&lt;/h1&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (url === <span class="string">&#x27;/&#x27;</span> || url === <span class="string">&#x27;/index.html&#x27;</span>) &#123;</span><br><span class="line">        content = <span class="string">&#x27;&lt;h1&gt;首页&lt;/h1&gt;&#x27;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (url === <span class="string">&#x27;/about.html&#x27;</span>) &#123;</span><br><span class="line">        content = <span class="string">&#x27;&lt;h1&gt;关于&lt;/h1&gt;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    res.<span class="property">statusCode</span>=<span class="number">200</span></span><br><span class="line">    res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/html; charset=utf-8&#x27;</span>)</span><br><span class="line">    res.<span class="title function_">end</span>(content)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">8080</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;http server running at http://127.0.0.1:8080&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>







<h1 id="模块化"><a href="#模块化" class="headerlink" title="模块化"></a>模块化</h1><h2 id="模块化的基本概念"><a href="#模块化的基本概念" class="headerlink" title="模块化的基本概念"></a>模块化的基本概念</h2><p>遵循固定的规则，把一个大文件拆成独立并互相依赖的多个小模块。</p>
<h2 id="Node-js-中的模块化"><a href="#Node-js-中的模块化" class="headerlink" title="Node.js 中的模块化"></a>Node.js 中的模块化</h2><h3 id="模块分类"><a href="#模块分类" class="headerlink" title="模块分类"></a>模块分类</h3><p>根据模块来源不同，分成三类</p>
<ul>
<li>内置模块（Node.js 官方提供。例如 fs，path，http 等）。</li>
<li>自定义模块（用户创建的每个 .js 文件，都是自定义模块）。</li>
<li>第三方模块（第三方开发出的模块，使用前需下载）。</li>
</ul>
<h3 id="加载模块"><a href="#加载模块" class="headerlink" title="加载模块"></a>加载模块</h3><p><code>require()</code> 方法，可以加载所有模块。内置模块和第三方模块不需要加路径，但用户自定义模块需要。</p>
<p>当使用 <code>require()</code> 方法加载其它模块时，会执行被加载模块中的代码。</p>
<p>加载自定义模块时，可以省略 <code>.js</code> 的后缀。</p>
<h3 id="模块作用域"><a href="#模块作用域" class="headerlink" title="模块作用域"></a>模块作用域</h3><p>和函数作用域类似，自定义模块中的变量、方法等成员，只能在模块内被访问。</p>
<p>好处：能够防止全局变量被污染。</p>
<h3 id="向外共享模块作用域的成员"><a href="#向外共享模块作用域的成员" class="headerlink" title="向外共享模块作用域的成员"></a>向外共享模块作用域的成员</h3><p><strong>module 对象</strong></p>
<p>在每个 <code>.js</code> 自定义模块中都有一个 module 对象，它里面存储了和当前模块有关的信息。</p>
<p><strong>module.exports 对象</strong></p>
<p>自定义模块中，可以使用 module.exports 对象，把模块内的成员共享出去。</p>
<p>外界用 <code>require()</code> 方法导入自定义模块时，得到的就是 module.exports 所指向的对象。</p>
<p><strong>exports 对象</strong></p>
<p>module.exports 写法复杂，引入了 exports 对象来替代它。二者作用一致，但最终结果以 module.exports 所指向的对象为准。</p>
<p>为防止混乱，尽量不要混用 module.exports 和 exports。</p>
<h3 id="Node-js-中的模块化规范"><a href="#Node-js-中的模块化规范" class="headerlink" title="Node.js 中的模块化规范"></a>Node.js 中的模块化规范</h3><p>Node.js 遵循了 CommonJS 模块化规范，CommonJS 规定了模块的特性和各模块之间如何相互依赖。</p>
<p>CommonJS 规定：</p>
<ol>
<li>每个模块内部，module 变量代表当前模块。</li>
<li>module 变量是一个对象，它的 <code>exports</code> （即 <code>module.exports</code>）是对外的接口。</li>
<li>加载某个模块，其实是加载该模块的 <code>module.exports</code> 属性。<code>require()</code> 方法用于加载模块。</li>
</ol>
<h2 id="npm-与-包"><a href="#npm-与-包" class="headerlink" title="npm 与 包"></a>npm 与 包</h2><p>包：第三方模块。由第三方个人或团队开发。免费供所有人使用。</p>
<p>包是由内置模块封装出来的，能够提升开发效率。</p>
<p>包和内置模块之间的关系，类似于 <code>jQuery </code>和 浏览器内置 api 之间的关系。</p>
<p>全球最大的包共享平台：<a target="_blank" rel="noopener" href="https://www.npmjs.com/">npm (npmjs.com)</a>（搜索包的服务器）。</p>
<p>下载包的服务器: <a target="_blank" rel="noopener" href="https://registry.npmjs.org/%E3%80%82">https://registry.npmjs.org/。</a></p>
<p>包管理工具 <code>Node Package Manager</code>（简称 <code>npm</code> 包管理工具），可以从下载包的服务器下载指定的包。</p>
<p><code>npm</code> 默认和 <code>node.js</code> 一起被安装到了电脑上。</p>
<h3 id="npm-初体验"><a href="#npm-初体验" class="headerlink" title="npm 初体验"></a>npm 初体验</h3><p>初次装包后，会多出一个 <code>node_modules</code> 文件夹和 <code>package-lock.json</code> 配置文件。</p>
<ul>
<li><code>node_modules</code>：存放安装到项目里的包。</li>
<li><code>package-lock.json</code>：记录下载到项目里面的每一个包的下载信息。</li>
</ul>
<p><code>npm</code> 会自动维护这些文件。</p>
<h3 id="包的版本"><a href="#包的版本" class="headerlink" title="包的版本"></a>包的版本</h3><p>可以通过 <code>包名@</code> 指定版本。</p>
<p>包的版本是由 <code>点分十进制</code> 的形式进行定义的，总共有三位数字。</p>
<ul>
<li>第一位：大版本。</li>
<li>第二位：功能版本。</li>
<li>第三位：Bug修复版本。</li>
</ul>
<p>版本号提升规则：前面版本号提升了，后面版本号归零。</p>
<h3 id="包管理配置文件"><a href="#包管理配置文件" class="headerlink" title="包管理配置文件"></a>包管理配置文件</h3><p><code>npm</code>规定，项目的根目录中，必须提供一个 <code>package.json</code> 的包管理配置文件。用来记录与项目有关的一些配置信息。例如：</p>
<ul>
<li>项目的名称、版本号、描述等。</li>
<li>项目中都用到了哪些包。</li>
<li>哪些包只在开发期间会用到。</li>
<li>哪些包在开发和部署时都要用到。</li>
</ul>
<p><strong>多人协作的问题</strong></p>
<p>第三方包体积过大，不方便组员共享源码。</p>
<p>解决方案：共享时剔除 <code>node_modules</code>。</p>
<p><strong>记录装了哪些包</strong></p>
<p>项目根目录的 <code>package.json</code> 配置文件。方便剔除 <code>node_modules</code> 后，仍然可以共享源码。</p>
<p>开发中就可以把 <code>node_modules</code> 文件夹添加到 <code>.gitignore</code> 忽略文件中。</p>
<p><strong>快速创建 package.json</strong></p>
<p>快捷命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm init -y</span><br></pre></td></tr></table></figure>

<p>该命令只能在英文目录下运行成功。</p>
<p>安装包时，<code>npm</code> 会自动把包的名称和版本号，记录到 <code>package.json</code> 中。</p>
<h3 id="dependencies-节点"><a href="#dependencies-节点" class="headerlink" title="dependencies 节点"></a>dependencies 节点</h3><p><code>package.json</code> 文件中，有一个 <code>dependencies</code> 节点，专门用来记录使用 npm install 命令安装的包。</p>
<h3 id="一次性安装所有的包"><a href="#一次性安装所有的包" class="headerlink" title="一次性安装所有的包"></a>一次性安装所有的包</h3><p>当我们拿到一个剔除了 <code>node_modules</code> 的项目之后，需要先把所有的包下载到项目中。</p>
<p>可以运行 npm install 命令（或 npm i）一次性安装所有的依赖包。</p>
<h3 id="卸载包"><a href="#卸载包" class="headerlink" title="卸载包"></a>卸载包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm unistall 包名称</span><br></pre></td></tr></table></figure>



<h3 id="devDependencies-节点"><a href="#devDependencies-节点" class="headerlink" title="devDependencies 节点"></a>devDependencies 节点</h3><p>记录只在开发阶段用到的包的信息。</p>
<p>记录方式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm i 包名 -D <span class="comment"># 简写</span></span><br><span class="line">npm i 包名 --save-dev <span class="comment"># 全写</span></span><br></pre></td></tr></table></figure>



<h3 id="解决下包速度慢的问题"><a href="#解决下包速度慢的问题" class="headerlink" title="解决下包速度慢的问题"></a>解决下包速度慢的问题</h3><p><strong>切换镜像源</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前的下包镜像源</span></span><br><span class="line">npm config get registry</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将下包的镜像源切换为淘宝镜像源</span></span><br><span class="line">npm config <span class="built_in">set</span> registry = http://registry.npm.taobao.org/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查镜像源是否切换成功</span></span><br><span class="line">npm config get registry</span><br></pre></td></tr></table></figure>



<p><strong>nrm</strong></p>
<p><code>nrm</code> 小工具提供的命令，可以快速查看和切换下包的镜像源。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载 nrm</span></span><br><span class="line">npm i nrm -g</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有可用镜像源</span></span><br><span class="line">nrm <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将下包镜像源切换为 taobao 镜像</span></span><br><span class="line">nrm use taobao</span><br></pre></td></tr></table></figure>



<h3 id="包的分类"><a href="#包的分类" class="headerlink" title="包的分类"></a>包的分类</h3><h4 id="项目包"><a href="#项目包" class="headerlink" title="项目包"></a>项目包</h4><p>被安装到 <code>node_modules</code> 中的包。</p>
<p>项目包分为两类：</p>
<ul>
<li>开发依赖包（<code>devDependencies </code> 节点中的包）。</li>
<li>核心依赖包（<code>dependencies</code> 节点中的包）。</li>
</ul>
<h4 id="全局包"><a href="#全局包" class="headerlink" title="全局包"></a>全局包</h4><p>执行 <code>npm install</code>  时，提供了 <code>-g</code> 参数的包。</p>
<p>注：只有工具性质的包，才有全局安装的必要。判断某个包是否为必须全局安装才能使用，须参考官方提供的说明。</p>
<h3 id="规范的包结构"><a href="#规范的包结构" class="headerlink" title="规范的包结构"></a>规范的包结构</h3><p>一个规范的包，必须符合以下三点要求：</p>
<ul>
<li>包必须以单独的目录而存在。</li>
<li>包的顶级目录下必须包含 <code>package.json</code> 这个包管理配置文件。</li>
<li><code>package.json</code> 中必须包含 <code>name</code>, <code>version</code>, <code>main</code> 这三个属性，分别代表包的名字、版本号、包的入口。</li>
</ul>
<h3 id="开发属于自己的包"><a href="#开发属于自己的包" class="headerlink" title="开发属于自己的包"></a>开发属于自己的包</h3><p><strong>初始化包的基本结构</strong></p>
<p>包文件夹中首先创建三个文件</p>
<ul>
<li><code>package.json</code> （包管理配置文件）。</li>
<li><code>index.js</code> （包的入口文件）。</li>
<li><code>README.md</code> （包的说明文档）。</li>
</ul>
<p><strong>初始化 <code>package.json</code></strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;包的名称&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;version&quot;</span><span class="punctuation">:</span><span class="string">&quot;版本&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;main&quot;</span><span class="punctuation">:</span><span class="string">&quot;包的入口&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;description&quot;</span><span class="punctuation">:</span><span class="string">&quot;包的描述&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;keywords&quot;</span><span class="punctuation">:</span><span class="string">&quot;关键词(数组)&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;license&quot;</span><span class="punctuation">:</span><span class="string">&quot;开源许可(默认 ISC)&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<p><strong>在 <code>index.js</code> 中编写功能</strong></p>
<p>······</p>
<p><strong>不同功能进行模块化拆分</strong></p>
<p>······</p>
<p><strong>编写包的说明文档</strong></p>
<p>编写 <code>README.md</code> 文档。</p>
<p>一般包含：安装方式、导入方式、功能介绍、开源协议。</p>
<h3 id="发布包"><a href="#发布包" class="headerlink" title="发布包"></a>发布包</h3><blockquote>
<p>发布包之前，一定要把下包的服务器切换到 <code>npm</code> 的官方服务器，否则会导致发布包失败。</p>
</blockquote>
<p>注册 <code>npm</code> 账号。</p>
<p>在控制台登录：<code>npm login</code> ，然后输入账号密码和邮箱。</p>
<p>把终端切换到 包的根目录下，运行 <code>npm publish</code> 命令，即可成功发布。（包名不能和已存在的包名重复）。</p>
<h3 id="删除已发布的包"><a href="#删除已发布的包" class="headerlink" title="删除已发布的包"></a>删除已发布的包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm unpublish 包名 --force</span><br></pre></td></tr></table></figure>

<p>注：</p>
<ul>
<li>只能删除发布 72 小时以内的包。</li>
<li>删除的包，24 小时内不允许重复发布。</li>
<li>发布包要慎重，尽量不发无意义的包。</li>
</ul>
<h2 id="模块的加载机制"><a href="#模块的加载机制" class="headerlink" title="模块的加载机制"></a>模块的加载机制</h2><h3 id="优先从缓存中加载"><a href="#优先从缓存中加载" class="headerlink" title="优先从缓存中加载"></a>优先从缓存中加载</h3><p>模块在第一次加载后会被缓存。即多次通过 <code>require()</code> 调用不会导致模块的代码被执行多次。能够提升模块的加载效率。</p>
<h3 id="内置模块加载机制"><a href="#内置模块加载机制" class="headerlink" title="内置模块加载机制"></a>内置模块加载机制</h3><p>内置模块的加载优先级最高。</p>
<h3 id="自定义模块加载机制"><a href="#自定义模块加载机制" class="headerlink" title="自定义模块加载机制"></a>自定义模块加载机制</h3><p>使用 <code>require()</code> 加载自定义模块时，必须指定以 <code>./</code>, <code>../</code> 开头的路径标识符。如果没有指定，<code>node</code> 会把它当作内置模块或第三方模块进行加载。</p>
<p>在使用 <code>require()</code> 导入自定义模块时，如果省略了文件的拓展名，则 <code>node.js</code> 会按顺序分别尝试加载以下的文件：</p>
<ol>
<li>按照确切的文件名进行加载。</li>
<li>补全 <code>.js</code> 拓展名进行加载。</li>
<li>补全 <code>.json</code> 拓展名进行加载。</li>
<li>补全 <code>.node</code> 拓展名进行加载。</li>
<li>加载失败，终端报错。</li>
</ol>
<h3 id="第三方模块的加载机制"><a href="#第三方模块的加载机制" class="headerlink" title="第三方模块的加载机制"></a>第三方模块的加载机制</h3><p>传递给 <code>require()</code> 的模块标识符不是一个内置模块，也没有以 <code>./</code> 或 <code>../</code> 开头，则 <code>Node.js</code> 会从当前模块的父目录开始，尝试从 <code>/node_modules</code> 文件夹中加载第三方模块。</p>
<p>如果没有找到对应的第三方模块，则移动到再上一层父目录中，进行加载，直到文件系统的根目录。</p>
<h3 id="目录作为模块"><a href="#目录作为模块" class="headerlink" title="目录作为模块"></a>目录作为模块</h3><p>目录作为模块标识符，传递给 <code>require()</code> 进行加载的时候，有三种加载方式：</p>
<ul>
<li>在被加载的目录下查找 <code>package.json</code>，并寻找 <code>main</code> 属性，作为 <code>require()</code> 的入口。</li>
<li>如果没有 <code>package.json</code>，或者 <code>main</code> 入口不存在或无法解析，则 <code>Node.js</code> 将会试图加载目录下的 index.js 文件。</li>
<li>如果以上两步都失败，<code>Node.js</code> 会在终端报错。</li>
</ul>
<h1 id="Express"><a href="#Express" class="headerlink" title="Express"></a>Express</h1><h2 id="初识-Express"><a href="#初识-Express" class="headerlink" title="初识 Express"></a>初识 Express</h2><p>官网：<a target="_blank" rel="noopener" href="https://www.expressjs.com.cn/">Express - 基于 Node.js 平台的 web 应用开发框架 - Express 中文文档 | Express 中文网 (expressjs.com.cn)</a></p>
<p>&#x3D;&#x3D;一个 <code>npm </code> 上的第三方包，能够快速创建 web 服务器。&#x3D;&#x3D;</p>
<p><code>http</code> 模块也能创建服务器，但开发效率低。<code>express</code> 就是对 <code>http</code> 模块的封装，极大的提高了开发效率。</p>
<h3 id="Express-基本使用"><a href="#Express-基本使用" class="headerlink" title="Express 基本使用"></a>Express 基本使用</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>在项目所处的目录，运行如下终端命令即可。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i express@4.17.1</span><br></pre></td></tr></table></figure>



<h4 id="创建基本-web-服务器"><a href="#创建基本-web-服务器" class="headerlink" title="创建基本 web 服务器"></a>创建基本 web 服务器</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">80</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;运行成功&quot;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<h4 id="监听-GET-请求"><a href="#监听-GET-请求" class="headerlink" title="监听 GET 请求"></a>监听 GET 请求</h4><p>通过 <code>app.get()</code> 方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;请求url&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">    <span class="comment">/* 处理函数 */</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<h4 id="监听-POST-请求"><a href="#监听-POST-请求" class="headerlink" title="监听 POST 请求"></a>监听 POST 请求</h4><p>通过 <code>app.post()</code> 方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;请求url&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">    <span class="comment">/* 处理函数 */</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<h4 id="把内容响应给客户端"><a href="#把内容响应给客户端" class="headerlink" title="把内容响应给客户端"></a>把内容响应给客户端</h4><p>通过 <code>res.send()</code> 方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/user&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 向客户端发送 json 对象</span></span><br><span class="line">    res.<span class="title function_">send</span>(&#123; <span class="attr">name</span>:<span class="string">&#x27;zs&#x27;</span>, <span class="attr">age</span>:<span class="string">&#x27;18&#x27;</span>, <span class="attr">gender</span>:<span class="string">&#x27;男&#x27;</span> &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/user&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 向客户端发送文本内容</span></span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&quot;请求成功&quot;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<h4 id="获取-URL-中的查询参数"><a href="#获取-URL-中的查询参数" class="headerlink" title="获取 URL 中的查询参数"></a>获取 URL 中的查询参数</h4><p>通过 <code>req.query</code> 对象获得</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/user&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 向客户端发送 json 对象</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">query</span>);</span><br><span class="line">    res.<span class="title function_">send</span>(&#123; <span class="attr">name</span>:<span class="string">&#x27;zs&#x27;</span>, <span class="attr">age</span>:<span class="string">&#x27;18&#x27;</span>, <span class="attr">gender</span>:<span class="string">&#x27;男&#x27;</span> &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<h4 id="获取-URL-中的动态参数"><a href="#获取-URL-中的动态参数" class="headerlink" title="获取 URL 中的动态参数"></a>获取 URL 中的动态参数</h4><p>通过 <code>req.params</code> 可以访问到 <code>URL</code> 中，通过 <code>:</code> 匹配到的动态参数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/user/:id&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 向客户端发送 json 对象</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">params</span>);</span><br><span class="line">    res.<span class="title function_">send</span>(&#123; <span class="attr">name</span>:<span class="string">&#x27;zs&#x27;</span>, <span class="attr">age</span>:<span class="string">&#x27;18&#x27;</span>, <span class="attr">gender</span>:<span class="string">&#x27;男&#x27;</span> &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<h3 id="托管静态资源"><a href="#托管静态资源" class="headerlink" title="托管静态资源"></a>托管静态资源</h3><p><code>express.static()</code> 能够非常方便地&#x3D;&#x3D;创建静态资源服务器&#x3D;&#x3D;。</p>
<p>例如：通过如下代码可以将 <code>public</code> 目录下的图片、css文件、JavaScript文件对外开放访问。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">static</span>(<span class="string">&#x27;public&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>注：<code>public</code> 文件夹的名称不会出现在 <code>url</code> 中。</p>
<p>例如：<code>127.0.0.1:80/html/index.html</code> 访问的是 <code>public</code> 文件夹下的 <code>html</code> 文件夹下的 <code>index.html</code> 文件。</p>
<p>托管多个静态资源目录，只需要多次调用 <code>express.static()</code>。</p>
<p>多次调用的情况下，访问的优先级为调用顺序。</p>
<p><code>express.static()</code> 可以添加路径参数。如：<code>app.use(&#39;/user&#39;, express.static(&#39;public&#39;))</code> 代表的是访问 <code>public</code> 文件夹内的内容，必须要加 <code>/user</code> 前缀。</p>
<h3 id="nodemon"><a href="#nodemon" class="headerlink" title="nodemon"></a>nodemon</h3><p>作用：&#x3D;&#x3D;监听项目文件变动，自动重启项目。&#x3D;&#x3D;</p>
<p><strong>安装方式</strong>：全局安装。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g nodemon</span><br></pre></td></tr></table></figure>



<p><strong>使用 nodemon</strong></p>
<p>运行项目时，将 <code>node</code> 命令替换为 <code>nodemon</code> 命令。</p>
<p>例：<code>nodemon index.js</code>。</p>
<h2 id="Express-路由"><a href="#Express-路由" class="headerlink" title="Express 路由"></a>Express 路由</h2><h3 id="路由的概念"><a href="#路由的概念" class="headerlink" title="路由的概念"></a>路由的概念</h3><p>广义上讲，路由就是映射关系。</p>
<p><strong><code>Express</code> 中的路由</strong></p>
<p>在 <code>Express</code> 中，路由指的是客户端的请求与服务器处理函数之间的映射关系。</p>
<p><code>Express</code> 中的路由由三部分组成，分别是请求的类型、请求的 URL 地址、处理函数，格式如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">METHOD</span>(<span class="variable constant_">PATH</span>, <span class="variable constant_">HANDLER</span>)</span><br></pre></td></tr></table></figure>



<h3 id="路由的使用"><a href="#路由的使用" class="headerlink" title="路由的使用"></a>路由的使用</h3><p><strong>路由的基本使用</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/router&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123; </span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&quot;hello router!&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/router&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123; </span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&quot;hello router!&quot;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<p><strong>模块化路由</strong></p>
<p>为了方便对路由进行模块化的管理，<code>Express</code> 不建议将路由直接挂载到 <code>app</code> 上，而是推荐将路由抽离为单独的模块。</p>
<p>步骤如下：</p>
<ol>
<li>创建路由模块对应的 <code>.js</code> 文件。</li>
<li>调用 <code>express.Router()</code> 函数创建路由实例。</li>
<li>向路由实例上挂载具体的路由。</li>
<li>使用 <code>module.exports</code> 向外共享路由文件。</li>
<li>使用 <code>app.use()</code> 函数注册路由模块。</li>
</ol>
<p><strong>为路由模块添加前缀</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入路由模块</span></span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="built_in">require</span>(<span class="string">&#x27;./router/user.js&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 app.use() 注册路由模块，并添加统一的访问前缀 /api</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&#x27;/api&#x27;</span>, userRouter)</span><br></pre></td></tr></table></figure>





<h2 id="Express-中间件"><a href="#Express-中间件" class="headerlink" title="Express 中间件"></a>Express 中间件</h2><p>中间件（Middleware），特指业务流程的中间处理环节。</p>
<p><strong>调用流程</strong></p>
<p>当一个请求到达 <code>Express</code> 的服务器后，可以连续调用多个中间件，从而对这次请求进行预处理。</p>
<p><strong><code>Express</code> 中间件的格式</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/get&#x27;</span>, <span class="keyword">function</span>(<span class="params">req, res,next</span>)&#123;</span><br><span class="line">    <span class="title function_">next</span>()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>中间件函数的形参列表中，必须包含 <code>next</code> 函数，而路由处理函数只包含 <code>req</code> 和 <code>res</code>。</p>
<p><strong><code>next</code> 函数的作用</strong></p>
<p><code>next</code> 函数是实现多个中间件连续调用的关键，它表示把流转关系转交给下一个中间件或路由。</p>
<h3 id="Express-中间件初体验"><a href="#Express-中间件初体验" class="headerlink" title="Express 中间件初体验"></a>Express 中间件初体验</h3><h4 id="定义中间件函数"><a href="#定义中间件函数" class="headerlink" title="定义中间件函数"></a>定义中间件函数</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mw = <span class="keyword">function</span> (<span class="params">req, res, next</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;一个最简单的中间件函数&#x27;</span>)</span><br><span class="line">    <span class="title function_">next</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="全局生效的中间件"><a href="#全局生效的中间件" class="headerlink" title="全局生效的中间件"></a>全局生效的中间件</h4><p>任何请求都会触发的中间件。</p>
<p>通过 <code>app.use(中间件函数)</code>，即可定义一个全局生效的中间件。示例代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mw = <span class="keyword">function</span> (<span class="params">req, res, next</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;一个最简单的中间件函数&#x27;</span>)</span><br><span class="line">    <span class="title function_">next</span>()</span><br><span class="line">&#125;</span><br><span class="line">app.<span class="title function_">use</span>(mw)</span><br></pre></td></tr></table></figure>



<h4 id="定义中间件函数的简化形式"><a href="#定义中间件函数的简化形式" class="headerlink" title="定义中间件函数的简化形式"></a>定义中间件函数的简化形式</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">use</span>(<span class="keyword">function</span> (<span class="params">req, res, next</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;一个最简单的中间件函数&#x27;</span>)</span><br><span class="line">    <span class="title function_">next</span>()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<h4 id="中间件的作用"><a href="#中间件的作用" class="headerlink" title="中间件的作用"></a>中间件的作用</h4><p>多个中间件共享一份 <code>req</code> 和 <code>res</code>。因此，我们可以在上游的中间件中统一为 <code>req</code> 和 <code>res</code> 对象添加自定义的属性或方法，供下游的中间件或路由使用。</p>
<h4 id="定义多个全局中间件"><a href="#定义多个全局中间件" class="headerlink" title="定义多个全局中间件"></a>定义多个全局中间件</h4><p>使用 <code>app.use()</code> 连续定义多个全局中间件。客户端请求到达服务器之后，会按照中间件定义的先后顺序依次进行调用。</p>
<p>例如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">use</span>(<span class="keyword">function</span> (<span class="params">req, res, next</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;第一个中间件&#x27;</span>)</span><br><span class="line">    <span class="title function_">next</span>()</span><br><span class="line">&#125;)</span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">function</span> (<span class="params">req, res, next</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;第二个中间件&#x27;</span>)</span><br><span class="line">    <span class="title function_">next</span>()</span><br><span class="line">&#125;)</span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">function</span> (<span class="params">req, res, next</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;第三个中间件&#x27;</span>)</span><br><span class="line">    <span class="title function_">next</span>()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<h4 id="局部生效的中间件"><a href="#局部生效的中间件" class="headerlink" title="局部生效的中间件"></a>局部生效的中间件</h4><p>不使用 <code>app.use()</code> 定义的中间件，为局部生效的中间件。示例代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义一个中间件函数 mw</span></span><br><span class="line"><span class="keyword">const</span> mw = <span class="keyword">function</span> (<span class="params">req, res, next</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;一个最简单的中间件函数&#x27;</span>)</span><br><span class="line">    <span class="title function_">next</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// mw 这个中间件只在 当前路由 生效</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/user/:id&#x27;</span>, mw, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 向客户端发送 json 对象</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">params</span>);</span><br><span class="line">    res.<span class="title function_">send</span>(&#123; <span class="attr">name</span>:<span class="string">&#x27;zhangsan&#x27;</span>, <span class="attr">age</span>:<span class="string">&#x27;18&#x27;</span>, <span class="attr">gender</span>:<span class="string">&#x27;男&#x27;</span> &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<h4 id="定义多个局部中间件"><a href="#定义多个局部中间件" class="headerlink" title="定义多个局部中间件"></a>定义多个局部中间件</h4><p>在路由中，通过如下两种等价的方式，使用多个局部中间件。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, mw1, mw2, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123; res.<span class="title function_">send</span>(<span class="string">&#x27;Page Home&#x27;</span>) &#125;)</span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, [mw1, mw2], <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123; res.<span class="title function_">send</span>(<span class="string">&#x27;Page Home&#x27;</span>) &#125;)</span><br></pre></td></tr></table></figure>



<h4 id="中间件的-5-个使用注意事项"><a href="#中间件的-5-个使用注意事项" class="headerlink" title="中间件的 5 个使用注意事项"></a>中间件的 5 个使用注意事项</h4><ol>
<li>一定要在路由之前注册中间件。</li>
<li>客户端发送过来的请求，可以连续调用多个中间件进行处理。</li>
<li>执行完中间件的业务代码后，不要忘记调用 <code>next()</code>  函数</li>
<li>为了防止代码逻辑混乱，调用 <code>next()</code> 函数后不要再写额外的代码。</li>
<li>连续调用多个中间件时，它们共享 <code>req</code> 和 <code>res</code> 对象。</li>
</ol>
<h3 id="中间件的分类"><a href="#中间件的分类" class="headerlink" title="中间件的分类"></a>中间件的分类</h3><p>为方便理解和记忆中间件的使用，<code>Express</code> 官方把中间件分为五大类。分别是：</p>
<ol>
<li>应用级别的中间件。</li>
<li>路由级别的中间件。</li>
<li>错误级别的中间件。</li>
<li><code>Express</code> 内置的中间件。</li>
<li>第三方的中间件。</li>
</ol>
<h4 id="应用级别的中间件"><a href="#应用级别的中间件" class="headerlink" title="应用级别的中间件"></a>应用级别的中间件</h4><p>通过绑定到 <code>app</code> 实例上的中间件。初体验中的示例均为应用级别。</p>
<h4 id="路由级别的中间件"><a href="#路由级别的中间件" class="headerlink" title="路由级别的中间件"></a>路由级别的中间件</h4><p>绑定到 <code>express.Router()</code> 实例上的中间件。示例代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = express.<span class="title class_">Router</span>()</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">use</span>(<span class="keyword">function</span> (<span class="params">res, req, next</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;路由级别的中间件&#x27;</span>)</span><br><span class="line">    <span class="title function_">next</span>()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/query&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&#x27;查询用户&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br></pre></td></tr></table></figure>



<h4 id="错误级别的中间件"><a href="#错误级别的中间件" class="headerlink" title="错误级别的中间件"></a>错误级别的中间件</h4><p>作用：专门用来捕获整个项目中发生的错误，从而防止项目异常崩溃的问题。</p>
<p>格式：错误级别中间件的 <code>function</code> 处理函数中，必须有四个形参，形参顺序从前到后，分别是 <code>(error, req, res, next)</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>)=&gt;</span>&#123;</span><br><span class="line">	<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;服务器内部发生了错误！&#x27;</span>)</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&#x27;Home Page&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">function</span>(<span class="params">error, req, res, next</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;发生了错误：&#x27;</span> + err.<span class="property">message</span>)</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&#x27;Error !&#x27;</span> + err.<span class="property">message</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>&#x3D;&#x3D;注：错误级别的中间件，必须注册在所有路由之后。&#x3D;&#x3D;</p>
<h4 id="Express-内置的中间件"><a href="#Express-内置的中间件" class="headerlink" title="Express 内置的中间件"></a>Express 内置的中间件</h4><p>从 <code>Express 4.16.0</code> 版本开始，<code>Express</code> 内置了 3 个常用的中间件：</p>
<ul>
<li><code>express.static</code>：快速托管静态资源的内置中间件。例如：<code>html</code> 文件、图片、<code>CSS</code> 样式等（无兼容性）。</li>
<li><code>express.json</code>：解析 <code>JSON</code> 格式的请求数据（有兼容性，仅在 <code>4.16.0+</code> 版本中可用）。通过 <code>req.body</code> 获取数据。不配置该中间件，<code>req.body</code> 为 <code>undefine</code>。</li>
<li><code>express.urlencoded</code>：解析 <code>URL-encoded</code> 格式的请求体数据（有兼容性，同上）。获取数据方式同上。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">json</span>())</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">unlencoded</span>(&#123;<span class="attr">extended</span>: <span class="literal">false</span>&#125;))</span><br></pre></td></tr></table></figure>



<h4 id="第三方的中间件"><a href="#第三方的中间件" class="headerlink" title="第三方的中间件"></a>第三方的中间件</h4><p>按需下载并配置的中间件。</p>
<p>例如：在 <code>Express 4.16.0</code> 之前的版本中，经常用 <code>body-parser</code> 这个第三方中间件，来解析请求体数据，使用步骤如下：</p>
<ol>
<li>运行 <code>npm install body-parser</code> 安装中间件。</li>
<li>使用 <code>require</code> 导入中间件。</li>
<li>调用 <code>app.use()</code> 注册并使用中间件。</li>
</ol>
<h2 id="使用-Express-写接口"><a href="#使用-Express-写接口" class="headerlink" title="使用 Express 写接口"></a>使用 Express 写接口</h2><h3 id="创建基本的服务器"><a href="#创建基本的服务器" class="headerlink" title="创建基本的服务器"></a>创建基本的服务器</h3><p><code>app.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">80</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Express server running at http://127.0.0.1&#x27;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<h3 id="创建-API-路由模块"><a href="#创建-API-路由模块" class="headerlink" title="创建 API 路由模块"></a>创建 API 路由模块</h3><p><code>router/index.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = express.<span class="title class_">Router</span>()</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br></pre></td></tr></table></figure>



<p><code>app.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;./router/index&#x27;</span>))</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&#x27;/api&#x27;</span>, router)</span><br></pre></td></tr></table></figure>



<h3 id="编写-get-接口"><a href="#编写-get-接口" class="headerlink" title="编写 get 接口"></a>编写 get 接口</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/query&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> id = req.<span class="property">query</span>.<span class="property">id</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(id);</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&#x27;查询用户&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<h3 id="编写-post-请求"><a href="#编写-post-请求" class="headerlink" title="编写 post 请求"></a>编写 post 请求</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//配置中间件</span></span><br><span class="line">router.<span class="title function_">use</span>(express.<span class="title function_">json</span>())</span><br><span class="line">router.<span class="title function_">use</span>(express.<span class="title function_">urlencoded</span>(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;))</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/add&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> body = req.<span class="property">body</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(body)</span><br><span class="line">    res.<span class="title function_">send</span>(&#123;</span><br><span class="line">        <span class="attr">status</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">msg</span>: <span class="string">&#x27;添加成功&#x27;</span>,</span><br><span class="line">        <span class="attr">data</span>: body</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<h3 id="CROS-跨域资源共享"><a href="#CROS-跨域资源共享" class="headerlink" title="CROS 跨域资源共享"></a>CROS 跨域资源共享</h3><p>上文的 <code>get</code> 和 <code>post</code> 请求是不支持跨域请求的。</p>
<p>解决跨域问题的解决方案主要有两种：</p>
<ul>
<li><code>CORS</code>（主流的解决方案）。</li>
<li><code>JSONP</code>（有缺陷的解决方案，只支持 GET 请求）。</li>
</ul>
<h4 id="使用-cors-中间件解决跨域问题"><a href="#使用-cors-中间件解决跨域问题" class="headerlink" title="使用 cors 中间件解决跨域问题"></a>使用 cors 中间件解决跨域问题</h4><p><code>cors</code>  是 <code>express</code> 的一个第三方中间件。通过安装和配置 <code>cors</code> 中间件，可以很方便的解决跨域问题。</p>
<p>使用步骤如下：</p>
<ol>
<li>运行 <code>npm install cors</code> 安装中间件。</li>
<li>使用 <code>const cors = require(&#39;cors&#39;)</code> 导入中间件。</li>
<li>路由之前调用 <code>app.use(cors())</code> 配置中间件。</li>
</ol>
<h4 id="什么是-CORS"><a href="#什么是-CORS" class="headerlink" title="什么是 CORS"></a>什么是 CORS</h4><p><code>CORS</code> 由一系列 <code>HTTP</code> 响应头组成，这些 <code>HTTP</code> 响应头决定浏览器是否阻止前端 <code>JS</code> 代码跨域获取资源。</p>
<p>浏览器的同源安全策略默认会阻止网页跨域获取资源。但如果接口服务器配置了 <code>CORS</code> 相关的 <code>HTTP</code> 响应头，就可以解除浏览器端的跨域访问限制。</p>
<h4 id="CORS-的注意事项"><a href="#CORS-的注意事项" class="headerlink" title="CORS 的注意事项"></a>CORS 的注意事项</h4><p><code>cors</code> 主要在服务端进行配置。客户端无需做任何额外的配置。</p>
<p><code>cors</code> 在浏览器有兼容性。只有支持 <code>XMLHttpRequest Level2</code> 的浏览器，才能正常访问开启了 <code>cors</code> 的服务端接口。</p>
<h4 id="CORS-响应头部"><a href="#CORS-响应头部" class="headerlink" title="CORS 响应头部"></a>CORS 响应头部</h4><p><strong>Access-Control-Allow-Origin</strong></p>
<p>响应头部中可以携带一个 <code>Access-Control-Allow-Origin</code> 字段，其语法如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Access</span>-<span class="title class_">Control</span>-<span class="title class_">Allow</span>-<span class="title class_">Origin</span>: &lt;origin&gt; | *</span><br></pre></td></tr></table></figure>



<p>其中，<code>origin</code> 的值制定了允许访问该资源的外域 URL。</p>
<p>例如，下面的字段值将只允许来自 <code>http://huangguosheng.com</code> 的请求</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Access-Control-Allow-Origin&#x27;</span>, <span class="string">&#x27;http://huangguosheng.com&#x27;</span>)</span><br></pre></td></tr></table></figure>



<p>若果指定了通配符 <code>*</code> ，则代表允许来自任何域的请求，示例代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Access-Control-Allow-Origin&#x27;</span>, <span class="string">&#x27;*&#x27;</span>)</span><br></pre></td></tr></table></figure>



<p><strong>Access-Control-Allow-Headers</strong></p>
<p>默认情况下，<code>CORS</code> 仅支持客户端向服务器发送如下的 9 个请求头：</p>
<p><code>Accept</code>, <code>Accept-language</code>, <code>Content-Language</code>, <code>DPR</code>, <code>Downlink</code>, <code>Save-Data</code>, <code>Viewport-Width</code>， <code>Width</code>, <code>Content-Type</code>(值仅限于：<code>text/plain</code>, <code>multipart/form-data</code>, <code>application/x-www-form-urlencoded</code>  三者之一))</p>
<p>如果客户端向服务器发送了额外的请求头信息，则需要在服务器端，通过Access-Control-Allow-Headers对额外的请求头进行声明，否则这次请求会失败!</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Access-Control-Allow-Headers&#x27;</span>, <span class="string">&#x27;Content-Type, X-Customer-Header&#x27;</span>)</span><br></pre></td></tr></table></figure>



<p><strong>Access-Control-Allow-Methods</strong></p>
<p>默认情况下，<code>CORS</code> 只支持 <code>GET</code>, <code>POST</code>, <code>HEAD</code> 请求。</p>
<p>如果客户端希望通过 <code>PUT</code>, <code>DELETE</code> 等方式请求服务器资源，则需要设置该请求头：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只允许 POST, GET, PUT, DELETE 方法</span></span><br><span class="line">res.<span class="title function_">set</span>(<span class="string">&#x27;Access-Control-Allow-Methods&#x27;</span>, <span class="string">&#x27;POST, GET, PUT, DELETE&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 允许所有的 HTTP 方法</span></span><br><span class="line">res.<span class="title function_">set</span>(<span class="string">&#x27;Access-Control-Allow-Methods&#x27;</span>, <span class="string">&#x27;*&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h4 id="CORS-请求的分类"><a href="#CORS-请求的分类" class="headerlink" title="CORS 请求的分类"></a>CORS 请求的分类</h4><p>客户端在请求 <code>CORS</code> 接口时，根据请求方式和请求头的不同，可以将 <code>CORS</code>  的请求分为两大类，分别是：</p>
<ol>
<li>简单请求。</li>
<li>预检请求。</li>
</ol>
<h4 id="简单请求"><a href="#简单请求" class="headerlink" title="简单请求"></a>简单请求</h4><p>满足以下两个条件的请求：</p>
<ul>
<li>请求方式：<code>GET</code>，<code>POST</code>，<code>HEAD</code> 三者之一。</li>
<li>HTTP头部信息不超过以下几种字段：无自定义头部字段、Accept、Accept-Language、Content-Language、DPR、Downlink、Save-Data、ViewportWidth、Width、Content-Type(只有三个值application&#x2F;x-www-form-urlencoded、multipart&#x2F;form-data、text&#x2F;plain)。</li>
</ul>
<h4 id="预检请求"><a href="#预检请求" class="headerlink" title="预检请求"></a>预检请求</h4><p>只要符合以下任何一个条件的请求，都需要进行预检请求：</p>
<ul>
<li>请求方式为：GET、POST、HEAD 之外的 Method 类型。</li>
<li>请求头中包含自定义头部字段。</li>
<li>向服务器发送了 application&#x2F;json 格式的数据。</li>
</ul>
<p>在浏览器与服务器正式通讯之前，浏览器会先发送 OPTION 请求进行预检验，以获知服务器是否允许该实际请求，所以这一次的 <code>OPTION</code> 请求称为”预检请求“。服务器成功响应后，才会发出真正的请求，并且携带真实的数据。</p>
<h4 id="简单请求和预检请求的区别"><a href="#简单请求和预检请求的区别" class="headerlink" title="简单请求和预检请求的区别"></a>简单请求和预检请求的区别</h4><p>简单请求的特点：客户端与服务器之间只会发生一次请求。</p>
<p>预检请求的特点：客户端与服务器之间会发生两次请求，OPTION 预检请求成功之后，才会发起真正的请求。</p>
<h3 id="JSONP-接口"><a href="#JSONP-接口" class="headerlink" title="JSONP 接口"></a>JSONP 接口</h3><p>浏览器端通过 &lt;script&gt; 标签的 src 属性， 请求服务器上的数据，同时，服务器返回一个函数的调用。</p>
<p>特点：</p>
<ol>
<li>JSONP 不属于真正的 Ajax 请求，因为它没有使用 XMLHttpRequest 对象。</li>
<li>JSONP 仅支持 GET 请求。</li>
</ol>
<p><strong>注意事项</strong>：</p>
<p>如果项目中已经配置了CORS 跨域资源共享，为了防止冲突，必须在配置CORS 中间件之前声明 JSONP的接口。否则<br>JSONP 接口会被处理成开启了CORS 的接口。示例代码如下:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/api/jsonp&#x27;</span>, <span class="function">(<span class="params">req, res</span>)=&gt;</span>&#123;&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">cors</span>())</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/api/get&#x27;</span>, <span class="function">(<span class="params">req, res</span>)=&gt;</span>&#123;&#125;)</span><br></pre></td></tr></table></figure>



<p><strong>实现 jsonp 接口的步骤</strong></p>
<ol>
<li>获得客户端发送过来的回调函数的名字。</li>
<li>得到通过 jsonp 形式发送给客户端的数据。</li>
<li>根据前两步得到的数据，拼接出一个函数调用的字符串。</li>
<li>把上一步拼接得到的字符串，响应给客户端的 &lt;script&gt; 客户端进行解析。</li>
</ol>
<p><strong>实现具体代码</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/api/jsonp&#x27;</span>, <span class="function">(<span class="params">req, res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> funcName = req.<span class="property">query</span>.<span class="property">callback</span></span><br><span class="line">    <span class="keyword">const</span> data = &#123; <span class="attr">name</span>: <span class="string">&#x27;zs&#x27;</span>, <span class="attr">age</span>: <span class="number">18</span> &#125;</span><br><span class="line">    <span class="keyword">const</span> scriptStr = <span class="string">`<span class="subst">$&#123;funcName&#125;</span>(<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(data)&#125;</span>)`</span></span><br><span class="line">    res.<span class="title function_">send</span>(scriptStr)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<p><strong>网页中发起 jsonp 请求</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;http://127.0.0.1/api/jsonp&#x27;</span></span><br><span class="line">    <span class="attr">dataType</span>: <span class="string">&#x27;jsonp&#x27;</span>,</span><br><span class="line">    <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params">res</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>







<h1 id="数据库与身份认证"><a href="#数据库与身份认证" class="headerlink" title="数据库与身份认证"></a>数据库与身份认证</h1><h2 id="在项目中操作数据库"><a href="#在项目中操作数据库" class="headerlink" title="在项目中操作数据库"></a>在项目中操作数据库</h2><h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><ol>
<li>安装 <code>MySQL</code> 数据库的第三方模块（mysql）。</li>
<li>通过 <code>mysql</code> 模块连接到 <code>MySQL</code> 数据库。</li>
<li>通过 <code>mysql</code> 模块执行 <code>sql</code> 语句。</li>
</ol>
<h3 id="安装模块"><a href="#安装模块" class="headerlink" title="安装模块"></a>安装模块</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install mysql</span><br></pre></td></tr></table></figure>



<h3 id="配置-mysql-模块"><a href="#配置-mysql-模块" class="headerlink" title="配置 mysql 模块"></a>配置 mysql 模块</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mysql = <span class="built_in">require</span>(<span class="string">&#x27;mysql&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> db = mysql.<span class="title function_">createPool</span>(&#123;</span><br><span class="line">    <span class="attr">host</span>: <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">    <span class="attr">user</span>: <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">    <span class="attr">password</span>: <span class="string">&#x27;1234&#x27;</span>,</span><br><span class="line">    <span class="attr">database</span>: <span class="string">&#x27;db1&#x27;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<h3 id="使用-mysql"><a href="#使用-mysql" class="headerlink" title="使用 mysql"></a>使用 mysql</h3><p><strong>查询</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="title function_">query</span>(<span class="string">&#x27;select * from stu&#x27;</span>, <span class="function">(<span class="params">err, results</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(results)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<p><strong>插入</strong></p>
<p>可以使用 <code>?</code> 作为占位符。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> user = &#123; <span class="attr">username</span>: <span class="string">&#x27;lisi&#x27;</span>, <span class="attr">password</span>: <span class="string">&#x27;1234&#x27;</span> &#125;</span><br><span class="line"><span class="keyword">const</span> sqlStr = <span class="string">&#x27;insert into users (username, password) values (?, ?)&#x27;</span></span><br><span class="line">db.<span class="title function_">query</span>(sqlStr, [user.<span class="property">username</span>, user.<span class="property">password</span>], <span class="function">(<span class="params">err, results</span>)=&gt;</span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(results.<span class="property">affectedRows</span> === <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;插入成功&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<p><strong>插入数据的便捷方式</strong></p>
<p>当数据对象每个属性和数据表的字段对应时，则可以直接把对象作为参数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> user = &#123; <span class="attr">username</span>: <span class="string">&#x27;lisi&#x27;</span>, <span class="attr">password</span>: <span class="string">&#x27;1234&#x27;</span> &#125;</span><br><span class="line"><span class="keyword">const</span> sqlStr = <span class="string">&#x27;insert into users set ?&#x27;</span></span><br><span class="line">db.<span class="title function_">query</span>(sqlStr, user, <span class="function">(<span class="params">err, results</span>)=&gt;</span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(results.<span class="property">affectedRows</span> === <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;插入成功&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<p><strong>更新数据及其快捷方式</strong></p>
<p>······</p>
<p><strong>删除数据及其快捷方式</strong></p>
<p>······</p>
<h2 id="Web-开发模式"><a href="#Web-开发模式" class="headerlink" title="Web 开发模式"></a>Web 开发模式</h2><p>目前主流的 web 开发模式有 2 种，分别是：</p>
<ol>
<li>基于服务端渲染的传统 web 开发模式。（前后端不分离）</li>
<li>基于前后端分离的新型 web 开发模式。（前后端分离）</li>
</ol>
<h2 id="前后端的身份认证"><a href="#前后端的身份认证" class="headerlink" title="前后端的身份认证"></a>前后端的身份认证</h2><h3 id="身份认证"><a href="#身份认证" class="headerlink" title="身份认证"></a>身份认证</h3><p>通过一定的手段，完成对用户身份的确认。</p>
<p><strong>不同开发模式下的身份认证</strong></p>
<ol>
<li>服务端渲染：Session 验证机制。</li>
<li>前后端分离： JWT 认证机制。</li>
</ol>
<h3 id="在-Express-中使用-Session-认证"><a href="#在-Express-中使用-Session-认证" class="headerlink" title="在 Express 中使用 Session 认证"></a>在 Express 中使用 Session 认证</h3><p><strong>安装 express-session 中间件</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install express-session</span><br></pre></td></tr></table></figure>



<p><strong>配置 express-session 中间件</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> session = <span class="built_in">require</span>(<span class="string">&#x27;express-session&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">session</span>(&#123;</span><br><span class="line">    <span class="attr">secret</span>: <span class="string">&#x27;zjut666&#x27;</span>,	<span class="comment">//secret 的值可以为任意字符串</span></span><br><span class="line">    <span class="attr">resave</span>: <span class="literal">false</span>,	<span class="comment">//固定写法</span></span><br><span class="line">    <span class="attr">saveUninitialized</span>: <span class="literal">true</span>	<span class="comment">//固定写法</span></span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure>



<p><strong>向 session 中存数据</strong></p>
<p>中间件配置成功后，即可通过 <code>req.session</code> 来访问和使用 <code>session</code> 对象，从而存储用户的关键信息：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">req.<span class="property">session</span>.<span class="property">user</span> = req.<span class="property">body</span> <span class="comment">//将用户的信息，存储到 Session 中</span></span><br><span class="line">req.<span class="property">session</span>.<span class="property">islogin</span> = <span class="literal">true</span></span><br></pre></td></tr></table></figure>



<p><strong>清空 session 信息</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">req.<span class="property">session</span>.<span class="title function_">destroy</span>()</span><br></pre></td></tr></table></figure>



<h3 id="JWT-认证机制"><a href="#JWT-认证机制" class="headerlink" title="JWT 认证机制"></a>JWT 认证机制</h3><h4 id="session-的局限性"><a href="#session-的局限性" class="headerlink" title="session 的局限性"></a>session 的局限性</h4><p>Session 认证机制需要配合 Cookie才能实现。由于 Cookie 默认不支持跨域访问，所以，当涉及到前端跨域请求后端接口的时候，需要做很多额外的配置，才能实现跨域 Session 认证。</p>
<p>注意：</p>
<ul>
<li>当前端请求后端接口不存在跨域问题的时候，推荐使用Session 身份认证机制。</li>
<li>当前端需要跨域请求后端接口的时候，不推荐使用Session身份认证机制，推荐使用 JWT 认证机制。</li>
</ul>
<h4 id="JWT-的使用方式"><a href="#JWT-的使用方式" class="headerlink" title="JWT 的使用方式"></a>JWT 的使用方式</h4><p>客户端收到 JWT 后，通常把它存到 localStorage 或 sessionStorage 中。</p>
<p>需要验证身份的请求就把 jwt 放在 HTTP 请求头的 Authorization 字段中，格式如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Authorization</span>: <span class="title class_">Bearer</span> &lt;token&gt;</span><br></pre></td></tr></table></figure>



<h3 id="在-Express-中使用-JWT"><a href="#在-Express-中使用-JWT" class="headerlink" title="在 Express 中使用 JWT"></a>在 Express 中使用 JWT</h3><h4 id="安装-jwt-包"><a href="#安装-jwt-包" class="headerlink" title="安装 jwt 包"></a>安装 jwt 包</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install jsonwebtoken express-jwt</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li>jsonwebtoken 用于生成 JWT 字符串。</li>
<li>express-jwt 用于将 JWT 字符串解析还原成 JSON 对象。</li>
</ul>
<h4 id="导入-jwt-包"><a href="#导入-jwt-包" class="headerlink" title="导入 jwt 包"></a>导入 jwt 包</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> expressJWT = <span class="built_in">require</span>(<span class="string">&#x27;express-jwt&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h4 id="定义-secret-密钥"><a href="#定义-secret-密钥" class="headerlink" title="定义 secret 密钥"></a>定义 secret 密钥</h4><p>为保证 jwt 的安全性，需要定义密钥来对其进行加密和解密。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> secretKey = <span class="string">&#x27;zjut666&#x27;</span></span><br></pre></td></tr></table></figure>



<h4 id="生成-jwt-字符串"><a href="#生成-jwt-字符串" class="headerlink" title="生成 jwt 字符串"></a>生成 jwt 字符串</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">jwt.<span class="title function_">sign</span>(&#123;</span><br><span class="line">        <span class="attr">username</span>: <span class="string">&#x27;zhangsan&#x27;</span>, </span><br><span class="line">        <span class="attr">password</span>: <span class="string">&#x27;1234&#x27;</span></span><br><span class="line">	&#125;, </span><br><span class="line">    secretKey, </span><br><span class="line">    &#123;</span><br><span class="line">    	<span class="attr">expiresIn</span>:<span class="string">&#x27;30s&#x27;</span></span><br><span class="line">	&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<h4 id="解析-jwt-成-json"><a href="#解析-jwt-成-json" class="headerlink" title="解析 jwt 成 json"></a>解析 jwt 成 json</h4><p>通过 express-jwt 中间件来实现。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// unless 用来排除不需要验证的访问</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">expressJWT</span>(&#123;secretKey&#125;).<span class="title function_">unless</span>(&#123;<span class="attr">path</span>: [<span class="regexp">/^\/api\//</span>]&#125;))</span><br></pre></td></tr></table></figure>

<p>解析成功后，即可通过 req.user 或 req.auth 访问用户信息。</p>
<h4 id="捕获接卸-jwt-失败后的错误"><a href="#捕获接卸-jwt-失败后的错误" class="headerlink" title="捕获接卸 jwt 失败后的错误"></a>捕获接卸 jwt 失败后的错误</h4><p>若 Token  过期或不合法影响项目的运行，可以注册一个全局的错误中间件，捕获相关错误进行处理。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">err, req, res, next</span>) =&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err.<span class="property">name</span> === <span class="string">&#x27;UnauthorizedError&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">send</span>(&#123;<span class="attr">status</span>: <span class="number">401</span>, <span class="attr">message</span>: <span class="string">&#x27;无效的 token&#x27;</span>&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    res.<span class="title function_">send</span>(&#123; <span class="attr">status</span>: <span class="number">500</span>, <span class="attr">message</span>: <span class="string">&#x27;未知错误&#x27;</span> &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>







<h1 id="项目实战"><a href="#项目实战" class="headerlink" title="项目实战"></a>项目实战</h1><h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><p><strong>初始化包管理配置文件</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm init -y</span><br></pre></td></tr></table></figure>



<p><strong>安装指定版本的 express</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i express@4.17.1</span><br></pre></td></tr></table></figure>



<p><strong>根目录下新建项目入口文件 app.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">80</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;server is running at http://127.0.0.1&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<h3 id="配置-cors-跨域"><a href="#配置-cors-跨域" class="headerlink" title="配置 cors 跨域"></a>配置 cors 跨域</h3><p><strong>安装中间件</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i cors@2.8.5</span><br></pre></td></tr></table></figure>



<p><strong>在 app.js 中导入并配置 cors 中间件</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cors = <span class="built_in">require</span>(<span class="string">&#x27;cors&#x27;</span>)</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">cors</span>())</span><br></pre></td></tr></table></figure>



<h3 id="配置解析表单数据的中间件"><a href="#配置解析表单数据的中间件" class="headerlink" title="配置解析表单数据的中间件"></a>配置解析表单数据的中间件</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">urlencoded</span>(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;))</span><br></pre></td></tr></table></figure>



<h3 id="初始化路由相关的文件夹"><a href="#初始化路由相关的文件夹" class="headerlink" title="初始化路由相关的文件夹"></a>初始化路由相关的文件夹</h3><p>在项目根目录中，新建 router 文件夹，用来存放所有的路由模块。路由模块中，只存放客户端的请求与处理函数之间的映射关系。</p>
<p>在项目根目录中，新建 router_handler 文件夹，用来存放所有的路由函数处理模块。专门负责存放每个路由对应的处理函数。</p>
<h3 id="初始化用户路由模块"><a href="#初始化用户路由模块" class="headerlink" title="初始化用户路由模块"></a>初始化用户路由模块</h3><p><code>router</code> 文件夹中新建 <code>user.js</code> 文件，作为用户的路由模块，并初始化如下代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = express.<span class="title class_">Router</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册新用户</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&#x27;register OK&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 登录</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&#x27;login OK&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将路由对象共享出去</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br></pre></td></tr></table></figure>



<p>在 app.js 中，导入并使用用户路由模块</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> userRouter = <span class="built_in">require</span>(<span class="string">&#x27;./router/user&#x27;</span>)</span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&#x27;/api/user&#x27;</span>, userRouter)</span><br></pre></td></tr></table></figure>



<h3 id="抽离用户路由模块中的处理函数"><a href="#抽离用户路由模块中的处理函数" class="headerlink" title="抽离用户路由模块中的处理函数"></a>抽离用户路由模块中的处理函数</h3><blockquote>
<p>目的：为了保证路由模块的纯粹性，所有的路由处理函数，必须抽离到路由处理函数模块中</p>
</blockquote>
<p>在 <code>/router_handler/user.js</code> 中，使用 <code>exports</code> 对象，分别向外共享如下两个函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.<span class="property">regUser</span> = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&#x27;register OK&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">login</span> = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&#x27;login OK&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>修改 <code>/router/user.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = express.<span class="title class_">Router</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> userHandler = <span class="built_in">require</span>(<span class="string">&#x27;../router_handler/user&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册新用户</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>, userHandler.<span class="property">regUser</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 登录</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, userHandler.<span class="property">login</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将路由对象共享出去</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br></pre></td></tr></table></figure>





<h2 id="登录注册"><a href="#登录注册" class="headerlink" title="登录注册"></a>登录注册</h2><h3 id="安装并配置-mysql-模块"><a href="#安装并配置-mysql-模块" class="headerlink" title="安装并配置 mysql 模块"></a>安装并配置 mysql 模块</h3><p><strong>安装</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i mysql@2.18.1</span><br></pre></td></tr></table></figure>



<p><strong>在项目根目录中新建 &#x2F;db&#x2F;index.js 文件，在此自定义模块中创建数据库的连接对象</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mysql = <span class="built_in">require</span>(<span class="string">&#x27;mysql&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> db = mysql.<span class="title function_">createPool</span>(&#123;</span><br><span class="line">    <span class="attr">host</span>: <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">    <span class="attr">user</span>: <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">    <span class="attr">password</span>: <span class="string">&#x27;1234&#x27;</span>,</span><br><span class="line">    <span class="attr">database</span>: <span class="string">&#x27;sqltest&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = db</span><br></pre></td></tr></table></figure>



<h3 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h3><h4 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h4><ol>
<li>检测表单数据是否合法。</li>
<li>检测用户名是否被占用。</li>
<li>对密码进行加密处理。</li>
<li>插入新用户。</li>
</ol>
<h4 id="密码加密"><a href="#密码加密" class="headerlink" title="密码加密"></a>密码加密</h4><p>使用 bcrypt 包</p>
<h2 id="数据库异步问题解决"><a href="#数据库异步问题解决" class="headerlink" title="数据库异步问题解决"></a>数据库异步问题解决</h2><p>使用 callback 回调：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">&#x27;../db/index&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sqlStr = &#123;</span><br><span class="line">    <span class="attr">getAll</span>: <span class="string">&#x27;select * from user&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getAll</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    db.<span class="title function_">query</span>(sqlStr.<span class="property">getAll</span>, <span class="function">(<span class="params">err, results</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">callback</span>(&#123;<span class="attr">code</span>: <span class="number">500</span>, <span class="attr">msg</span>: <span class="string">&#x27;未知错误&#x27;</span>&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">callback</span>(results)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//调用</span></span><br><span class="line"><span class="title function_">getAll</span>(<span class="function"><span class="params">results</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(results)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/04/27/NodeJS-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" data-id="clgz3udp10000asuc0i6zc3y2" data-title="NodeJS 学习笔记" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2023/04/27/hello-world/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Hello World</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">April 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/04/27/NodeJS-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">NodeJS 学习笔记</a>
          </li>
        
          <li>
            <a href="/2023/04/27/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>